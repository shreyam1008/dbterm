name: Release

on:
  push:
    branches:
      - "main"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-core:
    name: Build Core Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Build Core Artifacts
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w" -o dist/dbterm-linux-amd64 .
          GOOS=linux GOARCH=arm64 go build -trimpath -ldflags="-s -w" -o dist/dbterm-linux-arm64 .
          GOOS=darwin GOARCH=amd64 go build -trimpath -ldflags="-s -w" -o dist/dbterm-darwin-amd64 .
          GOOS=darwin GOARCH=arm64 go build -trimpath -ldflags="-s -w" -o dist/dbterm-darwin-arm64 .
          GOOS=windows GOARCH=amd64 go build -trimpath -ldflags="-s -w" -o dist/dbterm-windows-amd64.exe .

      - name: Upload Core Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-core
          path: dist/*
          if-no-files-found: error

  build-ios:
    name: Build iOS Artifact
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Build iOS arm64 C archive
        run: |
          mkdir -p dist
          SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          CC="$(xcrun --sdk iphoneos --find clang)"
          GOOS=ios GOARCH=arm64 CGO_ENABLED=1 CC="$CC" SDKROOT="$SDKROOT" \
          CGO_CFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0" \
          CGO_LDFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0" \
          go build -trimpath -buildmode=c-archive -ldflags="-s -w" -o dist/dbterm-ios-arm64.a .

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-ios
          path: |
            dist/dbterm-ios-arm64.a
            dist/dbterm-ios-arm64.h
          if-no-files-found: error

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-core, build-ios]
    steps:
      - name: Checkout code (tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          fetch-tags: true

      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist

      - name: Generate Next Version
        id: bump_version
        run: |
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"

          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]:-0}
          MINOR=${PARTS[1]:-0}
          PATCH=${PARTS[2]:-0}
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v$MAJOR.$MINOR.$NEW_PATCH"
          NEW_VERSION="${NEW_TAG#v}"

          echo "New version: $NEW_TAG"
          echo "tag_name=$NEW_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "commit_msg<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMIT_MSG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Generate Checksums
        run: |
          ./scripts/build-deb.sh "${{ steps.bump_version.outputs.version }}" dist
          cd dist
          sha256sum * > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump_version.outputs.tag_name }}
          name: ${{ steps.bump_version.outputs.tag_name }} - ${{ steps.bump_version.outputs.commit_msg }}
          files: dist/*
          generate_release_notes: true

      - name: Publish APT repository (gh-pages)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAG_NAME: ${{ steps.bump_version.outputs.tag_name }}
        run: |
          set -euo pipefail
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          PAGES_DIR="/tmp/dbterm-gh-pages"

          rm -rf "$PAGES_DIR"
          if git ls-remote --exit-code --heads "$REPO_URL" gh-pages >/dev/null 2>&1; then
            git clone --depth 1 --branch gh-pages "$REPO_URL" "$PAGES_DIR"
          else
            git clone --depth 1 "$REPO_URL" "$PAGES_DIR"
            cd "$PAGES_DIR"
            git checkout --orphan gh-pages
            git rm -rf . >/dev/null 2>&1 || true
            find . -mindepth 1 -maxdepth 1 ! -name .git -exec rm -rf {} +
            cd -
          fi

          ./scripts/build-apt-repo.sh "$PAGES_DIR/apt" dist
          touch "$PAGES_DIR/.nojekyll"

          cd "$PAGES_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add apt .nojekyll
          if git diff --cached --quiet; then
            echo "No APT repository changes to publish."
            exit 0
          fi

          git commit -m "apt: publish ${TAG_NAME}"
          git push origin gh-pages
